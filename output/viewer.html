<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Double Pendulum Random Viewer</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0a0a0a;
            color: #fff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        h1 {
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #666;
            font-size: 14px;
            margin-bottom: 30px;
        }
        .viewer-container {
            background: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
            max-width: 800px;
            width: 100%;
        }
        .pendulum-display {
            position: relative;
            width: 100%;
            aspect-ratio: 2 / 1;
            background: #000;
            overflow: hidden;
            cursor: pointer;
        }
        .pendulum-display img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
            aspect-ratio: 2 / 1;
            background: transparent;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
            -webkit-mask-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSIzMiIgZmlsbD0iI2ZmZiI+PGRlZnM+PHBhdHRlcm4gaWQ9ImRvdCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PGNpcmNsZSBjeD0iLjUiIGN5PSIuNSIgcj0iLjMiLz48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZG90KSIvPjwvc3ZnPg==');
            -webkit-mask-repeat: no-repeat;
            -webkit-mask-size: contain;
            mask-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI2NCIgaGVpZ2h0PSIzMiIgZmlsbD0iI2ZmZiI+PGRlZnM+PHBhdHRlcm4gaWQ9ImRvdCIgd2lkdGg9IjEiIGhlaWdodD0iMSIgcGF0dGVyblVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+PGNpcmNsZSBjeD0iLjUiIGN5PSIuNSIgcj0iLjMiLz48L3BhdHRlcm4+PC9kZWZzPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9InVybCgjZG90KSIvPjwvc3ZnPg==');
            mask-repeat: no-repeat;
            mask-size: contain;
        }
        .pendulum-display img.layer-1 {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
        .pendulum-display img.layer-2 {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 2;
            opacity: 1.0;
            mix-blend-mode: screen;
            filter: brightness(1.3);
        }
        .info-bar {
            padding: 15px 20px;
            background: #000;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .generation-info {
            font-size: 14px;
            color: #888;
        }
        .generation-info span {
            color: #fff;
            font-weight: 500;
        }
        .status {
            font-size: 12px;
            color: #666;
            font-style: italic;
        }
        .status.looping {
            color: #4a9;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-size: 14px;
            z-index: 10;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }
        button {
            padding: 10px 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            color: #fff;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        button:hover {
            background: #333;
            border-color: #555;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .count {
            margin-top: 20px;
            color: #666;
            font-size: 12px;
        }
        .theater-ui {
            text-align: center;
            margin-bottom: 20px;
        }
        body.theater-mode .theater-ui,
        body.theater-mode .info-bar {
            display: none;
        }
    </style>
</head>
<body>
    <div class="theater-ui">
        <h1>Double Pendulum Random Viewer</h1>
        <p class="subtitle">Mouse over to loop â€¢ Mouse out to auto-advance</p>

        <div class="controls">
            <button id="nextBtn">Next Random</button>
            <button id="toggleLoopBtn">Pause Auto-Advance</button>
            <button id="overlayBtn">Battle Mode: OFF</button>
            <button id="theaterBtn">Theater Mode: OFF</button>
        </div>

        <p class="count">299 generations available</p>
    </div>

    <div class="viewer-container">
        <div class="pendulum-display" id="display">
            <div class="loading" id="loading">Loading...</div>
            <img id="layer1" class="layer-1" alt="Layer 1">
            <img id="layer2" class="layer-2" alt="Layer 2">
        </div>
        <div class="info-bar">
            <div class="generation-info">
                Generation <span id="genId">-</span>
            </div>
            <div class="status" id="status">Auto-advancing...</div>
        </div>
    </div>

    <script>
        const generations = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300];

        let currentGen1 = null;
        let currentGen2 = null;
        let isLooping = false;
        let isPaused = false;
        let autoAdvanceTimeout = null;
        let overlayMode = false;

        const display = document.getElementById('display');
        const layer1 = document.getElementById('layer1');
        const layer2 = document.getElementById('layer2');
        const loading = document.getElementById('loading');
        const genId = document.getElementById('genId');
        const status = document.getElementById('status');
        const nextBtn = document.getElementById('nextBtn');
        const toggleLoopBtn = document.getElementById('toggleLoopBtn');

        function getRandomGeneration() {
            const idx = Math.floor(Math.random() * generations.length);
            return generations[idx];
        }

        function loadGeneration(gen) {
            currentGen1 = gen;
            currentGen2 = null;
            overlayMode = false;
            loading.style.display = 'block';
            layer1.style.display = 'none';
            layer2.style.display = 'none';
            genId.textContent = gen;

            const img = new Image();
            img.onload = () => {
                layer1.src = img.src;
                layer2.src = '';
                loading.style.display = 'none';
                layer1.style.display = 'block';
                layer2.style.display = 'none';

                if (!isPaused && !isLooping) {
                    startAutoAdvance(14500);  // ~11.5s animation + 3s fade
                }
            };
            img.src = `${gen}.webp`;
        }

        function loadOverlayGenerations(gen1, gen2) {
            currentGen1 = gen1;
            currentGen2 = gen2;
            overlayMode = true;
            loading.style.display = 'block';
            layer1.style.display = 'none';
            layer2.style.display = 'none';
            genId.textContent = `${gen1} + ${gen2}`;

            let loaded = 0;
            const checkBothLoaded = () => {
                loaded++;
                if (loaded === 2) {
                    loading.style.display = 'none';
                    layer1.style.display = 'block';
                    layer2.style.display = 'block';

                    if (!isPaused && !isLooping) {
                        startAutoAdvance(14500);  // ~11.5s animation + 3s fade
                    }
                }
            };

            const img1 = new Image();
            img1.onload = checkBothLoaded;
            img1.src = `${gen1}.webp`;
            layer1.src = img1.src;

            const img2 = new Image();
            img2.onload = checkBothLoaded;
            img2.src = `${gen2}.webp`;
            layer2.src = img2.src;
        }

        function startAutoAdvance(duration) {
            clearTimeout(autoAdvanceTimeout);

            autoAdvanceTimeout = setTimeout(() => {
                if (!isLooping && !isPaused) {
                    loadNext();
                }
            }, duration);

            updateStatus();
        }

        function loadNext() {
            if (overlayMode) {
                let gen1 = getRandomGeneration();
                let gen2 = getRandomGeneration();
                while (gen2 === gen1 && generations.length > 1) {
                    gen2 = getRandomGeneration();
                }
                loadOverlayGenerations(gen1, gen2);
            } else {
                let nextGen = getRandomGeneration();
                while (nextGen === currentGen1 && generations.length > 1) {
                    nextGen = getRandomGeneration();
                }
                loadGeneration(nextGen);
            }
        }

        function updateStatus() {
            if (isLooping) {
                status.textContent = 'Looping (mouse over)';
                status.classList.add('looping');
            } else if (isPaused) {
                status.textContent = 'Paused';
                status.classList.remove('looping');
            } else {
                status.textContent = 'Auto-advancing...';
                status.classList.remove('looping');
            }
        }

        display.addEventListener('mouseenter', () => {
            isLooping = true;
            clearTimeout(autoAdvanceTimeout);
            updateStatus();
        });

        display.addEventListener('mouseleave', () => {
            isLooping = false;
            if (!isPaused) {
                startAutoAdvance(5000);
            }
            updateStatus();
        });

        nextBtn.addEventListener('click', () => {
            clearTimeout(autoAdvanceTimeout);
            loadNext();
        });

        toggleLoopBtn.addEventListener('click', () => {
            isPaused = !isPaused;
            toggleLoopBtn.textContent = isPaused ? 'Resume Auto-Advance' : 'Pause Auto-Advance';

            if (isPaused) {
                clearTimeout(autoAdvanceTimeout);
            } else if (!isLooping) {
                loadNext();
            }
            updateStatus();
        });

        const overlayBtn = document.getElementById('overlayBtn');
        overlayBtn.addEventListener('click', () => {
            overlayMode = !overlayMode;
            overlayBtn.textContent = overlayMode ? 'Battle Mode: ON' : 'Battle Mode: OFF';
            loadNext();
        });

        const theaterBtn = document.getElementById('theaterBtn');
        theaterBtn.addEventListener('click', () => {
            document.body.classList.toggle('theater-mode');
            const isTheater = document.body.classList.contains('theater-mode');
            theaterBtn.textContent = isTheater ? 'Theater Mode: ON' : 'Theater Mode: OFF';
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.body.classList.remove('theater-mode');
                theaterBtn.textContent = 'Theater Mode: OFF';
            }
        });

        // Check URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const genParam = urlParams.get('gen');
        const loopParam = urlParams.get('loop');

        if (genParam) {
            // Load specific generation
            const gen = parseInt(genParam);
            if (generations.includes(gen)) {
                if (loopParam === '1') {
                    // Start in loop mode
                    isLooping = true;
                    isPaused = true;
                    toggleLoopBtn.textContent = 'Resume Auto-Advance';
                }
                loadGeneration(gen);
            }
        } else {
            loadNext();
        }
    </script>
</body>
</html>
